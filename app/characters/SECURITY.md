# Character 模块安全说明

## Public Bucket 的安全考虑

### 当前实现（Public Bucket）

**优点：**
- ✅ 简单直接，图片可以直接通过 URL 访问
- ✅ 不需要额外的签名步骤
- ✅ 性能好，CDN 可以直接缓存

**安全措施：**
1. **文件路径包含 user_id**：文件存储在 `characters/{user_id}/...` 路径下
2. **RLS 策略保护**：虽然文件可以公开访问，但只有用户自己可以上传/删除
3. **文件名包含时间戳**：降低被猜测的可能性

**潜在风险：**
- ⚠️ 如果知道文件路径，任何人都可以访问图片
- ⚠️ 如果 user_id 泄露，可能被枚举访问

### 更安全的方案：使用 Signed URL

如果对安全性有更高要求，可以使用 **Signed URL**（临时签名 URL）替代 Public URL。

**优点：**
- ✅ 更安全：URL 有时效性，过期后无法访问
- ✅ 可以控制访问权限
- ✅ 即使知道文件路径也无法直接访问

**缺点：**
- ⚠️ 需要定期刷新 URL（适合动态加载场景）
- ⚠️ 性能略差（需要生成签名）

## 推荐方案

### 方案 1：Public Bucket + 路径保护（当前实现）

**适用场景：** 头像和角色图片，对安全性要求不是极高

**安全措施：**
1. 确保 Storage 策略正确配置（用户只能上传/删除自己的文件）
2. 文件路径包含 user_id，降低被枚举的风险
3. 文件名使用时间戳和随机字符

**配置：**
```sql
-- Storage Policies（已在 schema.sql 中配置）
-- INSERT: 用户只能上传到自己的文件夹
-- DELETE: 用户只能删除自己的文件
```

### 方案 2：Private Bucket + Signed URL（更安全）

**适用场景：** 对安全性要求极高的场景

**实现方式：**
1. 将 bucket 设置为 Private
2. 使用 `createSignedUrl` 生成临时访问链接
3. URL 有过期时间（如 1 小时）
4. 前端需要定期刷新 URL

**代码示例：**
```typescript
// 生成签名 URL（1 小时有效）
const { data: { signedUrl } } = await supabaseAdminClient.storage
  .from("character-assets")
  .createSignedUrl(avatarFileName, 3600); // 3600 秒 = 1 小时
```

## 当前实现的安全性评估

### ✅ 已实施的安全措施

1. **RLS 策略**：用户只能操作自己的文件
2. **路径隔离**：每个用户的文件存储在独立文件夹
3. **文件名随机化**：使用时间戳和原始文件名

### ⚠️ 潜在风险

1. **文件路径可猜测**：如果知道 user_id，可能枚举文件
2. **文件永久可访问**：一旦知道 URL，永久有效

### 🛡️ 风险缓解

1. **user_id 是 UUID**：难以猜测
2. **文件名包含时间戳**：进一步降低被猜测的可能性
3. **仅头像和角色图片**：不包含敏感信息

## 建议

### 对于当前场景（角色头像和全身照）

**推荐：继续使用 Public Bucket**

**理由：**
1. 头像和角色图片本身不是高度敏感信息
2. 用户体验更好（图片加载快）
3. 已有 RLS 策略保护上传/删除权限
4. user_id 是 UUID，难以被枚举

### 如果需要更高安全性

**可以切换到 Signed URL 方案：**

1. 将 bucket 改为 Private
2. 修改 API 返回 Signed URL
3. 前端定期刷新 URL（如果图片需要长期显示）

## 实施 Signed URL 方案（可选）

如果需要，我可以帮您实现 Signed URL 方案。主要改动：

1. **API 层**：生成 Signed URL 而不是 Public URL
2. **前端层**：定期刷新 URL（如果图片需要长期显示）
3. **Bucket 配置**：改为 Private

## 总结

**当前 Public Bucket 方案的安全性：**
- ✅ 对于头像和角色图片场景，安全性足够
- ✅ 有 RLS 策略保护上传/删除权限
- ✅ user_id 是 UUID，降低被枚举的风险
- ⚠️ 如果知道 URL，可以访问图片（但这是预期行为）

**如果担心安全性，可以：**
1. 继续使用 Public Bucket（推荐，适合当前场景）
2. 切换到 Signed URL（更安全，但需要更多代码）

您希望我帮您实现 Signed URL 方案吗？

